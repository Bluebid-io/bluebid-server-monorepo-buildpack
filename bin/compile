#!/usr/bin/env bash
set -euo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=${3:-}

# import ALL config-vars into environment
if [[ -d "$ENV_DIR" ]]; then
  for f in "$ENV_DIR"/*; do
    export "$(basename "$f")"="$(<"$f")"
  done
fi

cd "$BUILD_DIR"
[[ ! -d api-server && -d bluebid-server ]] && cd bluebid-server

if [[ -z "${SERVICE:-}" ]]; then
  echo "✖ SERVICE must be set to api-server or jobs-server" >&2
  exit 1
fi

echo "→ npm install --workspaces"
npm install --workspaces

echo "→ building $SERVICE"
npm run -w "$SERVICE" build

echo "→ rewriting root Procfile from $SERVICE/Procfile"
rm -f Procfile
while IFS= read -r line; do
  name=${line%%:*}
  cmd=${line#*: }
  echo "$name: cd $SERVICE && $cmd"
done < "$SERVICE/Procfile" > Procfile

echo "✔ compile done for $SERVICE"
